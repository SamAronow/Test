<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Song Quiz Test</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    #micBtn { background-color: red; color: white; border-radius: 50%; width: 80px; height: 80px; font-size: 14px; }
    #status { margin-top: 20px; font-size: 18px; }
  </style>
</head>
<body>

<h1>ðŸŽµ Song Quiz ðŸŽµ</h1>
<div id="screen"></div>

<script>
let screen = document.getElementById("screen");
let players = [];
let currentPlayer = 0;
let genre = "";
let scores = [];
let recognition;
let totalRounds = 5; // 5 rounds per player
let currentRound = 1; // starts at round 1
let clipCounter = 1; // total clip count across all players

function startGame() {
  screen.innerHTML = "<h2>Select Number of Players</h2>" +
    "<button onclick='setPlayers(2)'>2</button>" +
    "<button onclick='setPlayers(3)'>3</button>" +
    "<button onclick='setPlayers(4)'>4</button>";
}

function setPlayers(num) {
  players = Array.from({length: num}, (_, i) => `Player ${i+1}`);
  scores = new Array(num).fill(0);
  selectGenre();
}

function selectGenre() {
  screen.innerHTML = "<h2>Select Genre</h2>" +
    "<button onclick='setGenre(\"Test Genre\")'>Test Genre</button>";
}

function setGenre(selected) {
  genre = selected;
  playTurn();
}

function playTurn() {
  if (currentRound > totalRounds) {
    showWinner();
    return;
  }

  let playerName = players[currentPlayer];
  let song = {
    title: "test audio",
    artist: "clip"+clipCounter.toString()
  };
  console.log(song.artist, song.title);

  playTestAudio(clipCounter);

  screen.innerHTML = `<h2>${playerName}'s Turn â€” Round ${currentRound} of ${totalRounds}</h2>
    <p>Guess the song and artist!</p>
    <p>(Clip #${clipCounter})</p>
    <button id="micBtn" onmousedown="startListening('${song.title}', '${song.artist}')" onmouseup="stopListening()">ðŸŽ¤</button>
    <div id="status">Hold the mic to speak</div>
    <p>Scores: ${scores.map((s, i) => `${players[i]}: ${s}`).join(" | ")}</p>`;
}

// Play "This is test audio X"
function playTestAudio(num) {
  let utterance = new SpeechSynthesisUtterance(`This is test audio ${num}`);
  utterance.rate = 0.8;
  utterance.pitch = 1;
  speechSynthesis.speak(utterance);
}

function startListening(correctTitle, correctArtist) {
  if (!('webkitSpeechRecognition' in window)) {
    alert("Speech recognition not supported in this browser. Try Chrome.");
    return;
  }

  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onresult = function(event) {
    let transcript = event.results[0][0].transcript.toLowerCase();

    document.getElementById("status").innerText = "You said: " + transcript;

    let gotTitle = transcript.includes(correctTitle.toLowerCase());
    let gotArtist = transcript.includes(correctArtist.toLowerCase());

    let points = 0;
    if (gotTitle && gotArtist) points = 20;
    else if (gotTitle || gotArtist) points = 10;

    scores[currentPlayer] += points;

    document.getElementById("status").innerText += ` â†’ +${points} points!`;

    // Move to next player/round after short delay
    setTimeout(() => {
      clipCounter++;
      currentPlayer++;
      if (currentPlayer >= players.length) {
        currentPlayer = 0;
        currentRound++;
      }
      playTurn();
    }, 2000);
  };

  recognition.start();
}

function stopListening() {
  if (recognition) recognition.stop();
}

function showWinner() {
  let maxScore = Math.max(...scores);
  let winners = players.filter((p, i) => scores[i] === maxScore);
  let winnerText = winners.length > 1 ? `It's a tie between ${winners.join(", ")}!` : `${winners[0]} wins!`;

  screen.innerHTML = `<h2>Game Over!</h2>
    <p>Final Scores:</p>
    <p>${scores.map((s, i) => `${players[i]}: ${s}`).join(" | ")}</p>
    <h3>${winnerText}</h3>`;
}

startGame();
</script>

</body>
</html>
